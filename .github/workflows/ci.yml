name: CI/CD

on:
  push:
    branches: [main, staging, develop]
  pull_request:
    branches: [main, staging, develop]

jobs:
  # ==========================================
  # 1. VALIDATION DES COMMITS (PR uniquement)
  # ==========================================
  commitlint:
    name: üîç Lint Commit Messages
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install commitlint
        run: bun add -D @commitlint/config-conventional @commitlint/cli

      - name: Validate commits
        run: bunx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

  # ==========================================
  # 2. LINT (Core)
  # ==========================================
  lint-core:
    name: üîó Lint (Core)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile && cd packages/chill-ui-core && bun install --frozen-lockfile

      - name: Run ESLint
        run: cd packages/chill-ui-core && bun run lint

  # ==========================================
  # 3. TYPE CHECK (Core)
  # ==========================================
  type-check-core:
    name: üìò Type Check (Core)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-v2-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-v2-

      - name: Install dependencies
        run: bun install --frozen-lockfile && cd packages/chill-ui-core && bun install --frozen-lockfile

      - name: Run TypeScript check
        run: cd packages/chill-ui-core && bun run ts:check

  # ==========================================
  # 4. TESTS (Core)
  # ==========================================
  tests-core:
    name: ‚úÖ Tests (Core)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile && cd packages/chill-ui-core && bun install --frozen-lockfile

      - name: Run tests with coverage
        run: cd packages/chill-ui-core && bun run test

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

  # ==========================================
  # 5. CHECK COMPONENTS DOCUMENTATION
  # ==========================================
  check-components:
    name: üìö Check Components Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile && cd packages/chill-ui-core && bun install --frozen-lockfile

      - name: Check components documentation
        run: bun run check:components-docs

  # ==========================================
  # 7. G√âN√âRATION DES COMPOSANTS CORS
  # ==========================================
  generate-cors:
    name: üé® Generate CORS Components
    runs-on: ubuntu-latest
    needs: [lint-core, type-check-core, tests-core, check-components]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.BOT_ACTIONS_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate all CORS components
        run: bun run generate:cors:all

      - name: Upload generated files as artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-cors-${{ github.sha }}
          path: generated/
          retention-days: 3

  # ==========================================
  # 8. LINT FIX CORS G√âN√âR√âS
  # ==========================================
  lint-fix-generated-cors:
    name: üõ†Ô∏è Lint Fix Generated CORS
    runs-on: ubuntu-latest
    needs: [generate-cors]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download generated CORS
        uses: actions/download-artifact@v4
        with:
          name: generated-cors-${{ github.sha }}
          path: generated/

      - name: Auto-fix ESLint issues
        run: bun run lint:generated-cors:fix || true

      - name: Upload fixed generated files
        uses: actions/upload-artifact@v4
        with:
          name: generated-cors-${{ github.sha }}
          path: generated/
          overwrite: true

  # ==========================================
  # 9. TYPE CHECK CORS G√âN√âR√âS
  # ==========================================
  type-check-generated-cors:
    name: üìò Type Check Generated CORS
    runs-on: ubuntu-latest
    needs: [generate-cors]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download generated CORS
        uses: actions/download-artifact@v4
        with:
          name: generated-cors-${{ github.sha }}
          path: generated/

      - name: Run TypeScript check on generated CORS
        run: bun run ts:check:generated-cors

  # ==========================================
  # 10. BUILD (staging et main uniquement)
  # ==========================================
  build:
    name: üèóÔ∏è Build Packages
    runs-on: ubuntu-latest
    needs: [lint-fix-generated-cors, type-check-generated-cors]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download generated CORS
        uses: actions/download-artifact@v4
        with:
          name: generated-cors-${{ github.sha }}
          path: generated/

      - name: Build all packages
        run: bun run build:all

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.sha }}
          path: generated/
          retention-days: 7

  # ==========================================
  # 11. PACK (staging et main uniquement)
  # ==========================================
  pack:
    name: üì¶ Pack Packages
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ github.sha }}
          path: generated/

      - name: Pack all packages
        run: bun run pack:all

      - name: Upload packed artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ github.sha }}
          path: |
            generated/**/*.tgz
            generated/**/lib
          retention-days: 30

      - name: List generated packages
        run: |
          echo "üì¶ Packages g√©n√©r√©s :"
          find generated -name "*.tgz" -type f

  # ==========================================
  # 11. RELEASE & PUBLISH (staging et main)
  # ==========================================
  release:
    name: üöÄ Release & Publish to npm
    runs-on: ubuntu-latest
    needs: [pack]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/main')
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write # Required for OIDC authentication with npm

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.BOT_ACTIONS_ACCESS_TOKEN }}

      - name: Setup Node.js LTS
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          registry-url: "https://registry.npmjs.org"

      - name: Update npm
        run: npm install -g npm@latest

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download generated CORS
        uses: actions/download-artifact@v4
        with:
          name: generated-cors-${{ github.sha }}
          path: generated/

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git remote set-url origin https://x-access-token:${{ secrets.BOT_ACTIONS_ACCESS_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Run semantic-release
        run: bun run release
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_ACTIONS_ACCESS_TOKEN }}

      - name: Replace version placeholders
        run: bun run replace:version

      - name: Build all packages
        run: bun run build:all

      - name: Publish to npm
        run: |
          TAG="latest"
          if [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            TAG="next"
          fi

          echo "Publishing with tag: $TAG"

          cd generated/core-tailwind && npm publish --tag $TAG --access public --provenance
          cd ../core-stylesheet && npm publish --tag $TAG --access public --provenance

  # ==========================================
  # 12. SYNC MAIN ‚Üí STAGING
  # ==========================================
  sync-main-to-staging:
    name: üîÑ Sync main ‚Üí staging
    runs-on: ubuntu-latest
    needs: [release]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.BOT_ACTIONS_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Merge main into staging
        run: |
          git fetch origin main staging
          git checkout staging
          git merge origin/main --no-edit
          git push origin staging
          echo "‚úÖ Merged main into staging"

  # ==========================================
  # 15. SYNC STAGING ‚Üí DEVELOP
  # ==========================================
  sync-staging-to-develop:
    name: üîÑ Sync staging ‚Üí develop
    runs-on: ubuntu-latest
    needs: [sync-main-to-staging]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.BOT_ACTIONS_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Merge staging into develop
        run: |
          git fetch origin staging develop
          git checkout develop
          git merge origin/staging --no-edit
          git push origin develop
          echo "‚úÖ Merged staging into develop"
